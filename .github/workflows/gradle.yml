name: Builds app on all targets

on:
  workflow_dispatch:
  pull_request:
  push:

permissions:
  contents: read

jobs:
  build:
    strategy:
      matrix:
        include:
          # android
          - target: assembleRelease
            tag: android
            directory: composeApp/build/outputs/apk/release/composeApp-release-unsigned.apk
            os: ubuntu-latest
          # ios
          - target: iosSimulatorArm64Binaries
            tag: ios
            directory: composeApp/build/libs/composeApp-desktop.jar
            os: macos-latest
          # web
          - target: wasmJsBrowserDistribution
            tag: web
            directory: composeApp/build/dist/wasmJs/productionExecutable/
            os: ubuntu-latest
          # linux
          - target: desktopJar
            tag: linux
            directory: composeApp/build/libs/composeApp-desktop.jar
            os: ubuntu-latest
          # windows
          - target: desktopJar
            tag: windows
            directory: composeApp/build/libs/composeApp-desktop.jar
            os: windows-latest
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    - name: Validate Gradle Wrapper
      uses: gradle/wrapper-validation-action@v1
    - uses: actions/cache@v4
      with:
        path: |
          ~/.konan
        key: ${{ runner.os }}-${{ hashFiles('**/.lock') }}
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: 21
        distribution: 'zulu'
    - name: Build with Gradle
      uses: gradle/gradle-build-action@ce999babab2de1c4b649dc15f0ee67e6246c994f
      with:
        arguments: ${{ matrix.target }}
    # Set Current Date As Env Variable
    - name: Set current date as env variable
      run: echo "date_today=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

    # Set Repository Name As Env Variable
    - name: Set repository name as env variable
      run: |
        echo "repository_name=$(echo '${{ github.repository }}' \
            | awk -F '/' '{print $2}')" >> $GITHUB_ENV
    - name: Upload artifacts - ${{ env.repository_name }}
      uses: actions/upload-artifact@v4
      with:
        name:  ${{ env.repository_name }}-${{ matrix.tag }}-${{ env.date_today }}-artifact
        path: ${{ matrix.directory }}
